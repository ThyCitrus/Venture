BASE_MAP = [
    r".....................................................................................................................................................____..............",
    r"..................................................................|>.............................................................................__(`....')___.........",
    r"..................^..........^.........................|>.....___/|\___........................................................................(`........... .`).......",
    r".................^^^......↑^^^^......................../\..../ ELDORIA \...|>.............................^..........^..........................(._._....*._.^.`)......",
    r"................↑^^^^....`^^^`^^.......^...............||..|_|‾|_|‾|_|‾|_|./\............................↑^^.......^^↑^.........................*..^.*.**..*.║.........",
    r"...............^^`^^^..^^^^^^^^^^^...^^`^^.............||..|#############|.||.....^......^.......^...^..^^^^^....`^^^`^^.......^................^.*║**..*.**.║.*.......",
    r".............^^^^^^^^`^`^..`.^^^^^^`.^^^`^↑^^......^...|^...|###########|..||↑↑↑.↑^`....^^^^.....^^`.^^^`^`^^^..^^^^^^^^^^^↑..^^`^^.............║..║....*..^.║..^......",
    r"..........^^^^`|‾|‾|^^↑^`^~..^^^^^`^^^^..^^^^`^...^^^..^`^↑.|###########|.↑↑↑↑..^^^^.^^^^^^^..^^^^^^^.^^^^^^^`^^^..`.^^^^^^`.^^^`^^↑^...........<=..║*.^...║....║......",
    r".↑↑↑↑↑↑..^^^↑^^|_|_|^^^`^^.~..^^^^^`^^^^^.``^^^.^^^^^.^^^^^^^↑↑↑####↑↑↑↑↑↑↑↑.↑↑`^^^`^^^^.↑.^^^^^^↑^^^`.^^`^^^^^^^^..^^^^^`^^^^..^^^^`^............^*^.^*^.^.^..*║......",
    r"...↑↑↑↑↑↑↑↑↑ LUNARA ^↑↑^~~↑^^^↑↑↑↑↑.......↑↑↑↑↑↑↑^^`^^^^^^^`^^.↑↑↑↑↑↑↑↑↑↑↑..^^^^^^^^^`^^.^^^^^^`^^^^`^^`^^^^^^^`^^^...^^^^^`^^^^^.↑^^^........↑↑↑| FROSTHOLM |.....↑...",
    r"..........↑↑↑↑↑↑↑.~.↑↑↑↑↑↑↑↑↑...↑↑↑↑↑↑↑↑.↑↑↑↑^.↑↑^.^^`^^^^^^^^^^..↑↑↑↑↑↑.^^^^^^`^^^^^^^.^^↑^^######^^^^^^`..^^^^^^^^^^.^^^.↑↑↑↑↑↑↑↑↑↑↑↑↑..↑↑↑↑↑...‾=‾=‾=‾=‾=‾..........",
    r"......./‾‾‾\.....~./‾‾‾\..↑↑↑↑↑↑.....↑↑↑↑↑↑↑↑↑↑^^^^^^^^^^^^^^^^`^^^.║↑...↑↑↑↑↑↑↑↑↑↑↑↑↑^^^^^^##   ####^^^^^^^^.↑↑↑↑↑↑↑↑↑↑↑↑↑↑..↑↑↑↑↑↑↑↑↑↑↑↑↑↑.)())/((|\))\))(|))())(\\).",
    r".......|...|..===..|...|........................................↑↑↑↑║↑↑↑↑↑↑↑↑......↑↑↑↑↑.... CAVE ....↑↑↑↑↑↑↑↑↑↑↑...↑↑↑↑↑↑↑↑↑↑↑↑↑........(()..\......||\....|...//..)..",
    r"........║....~~.........................↑...........................║...................................↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑......................................↑↑........",
    r"........║...~~,.....................................................║.........................................................................................↑........",
    r"........║...~~~~~,,................↑↑↑....................↑↑↑↑↑↑↑↑↑↑↑↑↑........................................................↑↑..............,,,,,,,,,...............",
    r".......↑║....,~~~~~~~~,,,........................↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑.....................↑↑↑.............................↑↑↑.↑↑.............,,~~~~~,,,,.........↑↑...",
    r"........║......,~~~~~~~~~~~~,,.....................↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑..................↑↑↑↑......../‾‾‾\../‾‾\..........................,,,~~~~~~~~,,,,,............",
    r"........║.....,~~~~~~~~~~~~~~~~~,,.................↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑=↑↑↑↑↑....↑↑↑↑..........↑↑↑...../‾‾\./‾‾‾\|..|......................,,,,,~~~~~~~~~~~~~~,,,,,,.......",
    r"...↑....║....,~~~~~~~~~~~~~~~~~~~~======================↑↑=↑↑↑↑↑↑↑↑↑↑↑↑=↑↑↑↑↑↑↑↑===================|..|.|.../‾‾‾\..................,,,,,,,~~~~~~~~~~~~~~~~~~~~,,,......",
    r"........║...,~~~~~~~~~~~ LAKE ~~~~~~~~~.......↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑=↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑................|..|.|...|...|..........,,,,,,,,,~~~~~~~~~~~~~~~~~~~~~~~~~~~~,,,....",
    r"........║...,~~~~~~~~~~~~~~~~~~~~~~~~~..............↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑................... KIMAER ......,,,,,,,,~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~,,,,",
    r"↑↑↑↑↑↑↑↑║....,~~~~~~~~~~~~~~~~~~~~~~,..................↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑..................↑↑↑............,,,,,,,,,~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~,,",
    r"↑↑|||↑↑↑║|........~~~~~~~~~~~~~~~~;...................↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑....................↑↑↑.....,,,,,,,,,,,,,~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~,,,,~~~ LITORAL ~~~,",
    r"↑↑↑↑↑↑↑↑║↑↑↑||.........~~~~~~~~,,....................↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑.......................,,,,,,,,,,,,,,,~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~,,,....↑,,,~ ISLAND ~~~,",
    r"↑↑↑↑↑↑↑↑↑↑↑|↑↑↑↑↑|||........~~~~,....................↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑....................,,,,,,,,,~~~~~~~~~~~║║~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~;,.↑.......,,~~~~~~~~~",
    r"↑↑↑↑↑↑↑||↑↑↑↑↑↑↑↑↑↑↑↑.........~~~~~~,,,,................↑↑↑↑↑↑↑↑↑↑.................,,,,,,~~~~~~~~~~~~~~~~~~~~║~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~,,..↑.....↑..~~~~~~~~",
    r"↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑|||↑.........~~~~~~,,,,..............↑↑↑↑↑↑................,,,,~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~;,,;~~,;..,;~~~~~~~~",
    r"↑↑ DUSKWOOD ↑↑↑↑|↑↑↑↑↑↑↑↑.........~~~~~~~~~~~~,,..............................,,,,,~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ GULF OF BURHKERIA ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~",
    r"↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑|||............~~~~~~~~~~~,..........................,,,,,,,~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~",
    r"↑↑↑↑||↑↑↑↑↑||||↑↑↑↑↑↑↑↑|..........,,,~~~~~~~~~~~~..................↑......,,,,~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~",
    r"↑↑↑↑↑↑|↑↑↑↑↑↑↑↑↑↑↑↑||↑↑||........~~~~~~~~~~~~~~~~,.................,,,,,,,,,~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~",
]
LOCATIONS = {
    "eldoria": {
        "rows": [{"y": 3, "name": "ELDORIA"}],
        "color": (255, 200, 50),
        "display": "Eldoria",
        "hidden_char": ".",
    },
    "lunara": {
        "rows": [{"y": 9, "name": "LUNARA"}],
        "color": (150, 100, 255),
        "display": "Lunara",
        "hidden_char": "↑",
    },
    "cave": {
        "rows": [{"y": 12, "name": "CAVE"}],
        "color": (150, 150, 150),
        "display": "The Cave",
        "hidden_char": "↑",
    },
    "frostholm": {
        "rows": [{"y": 9, "name": "FROSTHOLM"}],
        "color": (150, 200, 200),
        "display": "Frostholm",
        "hidden_char": ".",
    },
    "kimaer": {
        "rows": [{"y": 21, "name": "KIMAER"}],
        "color": (200, 250, 0),
        "display": "Kimaer",
        "hidden_char": ".",
    },
    "duskwood": {
        "rows": [{"y": 28, "name": "DUSKWOOD"}],
        "color": (15, 150, 50),
        "display": "Duskwood",
        "hidden_char": "↑",
    },
    "litoral_island": {
        "rows": [
            {"y": 23, "name": "LITORAL"},
            {"y": 24, "name": "ISLAND"},
        ],
        "color": (100, 200, 255),
        "display": "Litoral Island",
        "hidden_char": "~",
    },
    "gulf_of_burhkeria": {
        "rows": [{"y": 28, "name": "GULF OF BURHKERIA"}],
        "color": (30, 120, 170),
        "display": "Gulf of Burhkeria",
        "hidden_char": "~",
    },
    "lake": {
        "rows": [{"y": 20, "name": "LAKE"}],
        "color": (0, 150, 255),
        "display": "Gulf of Burhkeria",
        "hidden_char": "~",
    },
}


def _travel_map():
    from core.locations import kimaer

    return {
        "kimaer": kimaer,
        "eldoria": None,
        "lunara": None,
        "cave": None,
        "frostholm": None,
        "duskwood": None,
        "litoral_island": None,
        "lake": None,
        "gulf_of_burhkeria": None,
    }


def render_map(state) -> list[str]:
    rows = [list(row) for row in BASE_MAP]
    visited = {k.lower() for k in state.locations_visited}
    for loc_id, loc in LOCATIONS.items():
        if loc_id not in visited:
            ch = loc.get("hidden_char", ".")
            for entry in loc["rows"]:
                row_str = "".join(rows[entry["y"]])
                padded = " " + entry["name"] + " "
                replacement = ch * len(padded)
                row_str = row_str.replace(padded, replacement)
                rows[entry["y"]] = list(row_str)
    return ["".join(row) for row in rows]


def show_map(state) -> None:
    from core.utils import clear, print_color, flush_input, press_any_key, write_slow

    clear()
    visited = {k.lower() for k in state.locations_visited}
    rendered = render_map(state)

    for line in rendered:
        colored = line
        for loc_id, loc in LOCATIONS.items():
            if loc_id in visited:
                r, g, b = loc["color"]
                for entry in loc["rows"]:
                    name = entry["name"]
                    if name in colored:
                        colored = colored.replace(
                            name, f"\033[38;2;{r};{g};{b}m{name}\033[0m"
                        )
        print(colored)
    print()

    discovered = {k: v for k, v in LOCATIONS.items() if k in visited}

    if not discovered:
        print_color("No locations discovered yet.", 150, 150, 150)
        input()
        return

    print_color("=== Known Locations ===", 255, 255, 255)
    print()
    keys = list(discovered.keys())
    for i, loc_id in enumerate(keys, 1):
        loc = discovered[loc_id]
        r, g, b = loc["color"]
        print_color(f"{i}. {loc['display']}", r, g, b)
    print()
    print_color("0. Close map", 150, 150, 150)
    print()

    travel = _travel_map()
    flush_input()

    while True:
        try:
            choice = int(input("> ").strip())
        except ValueError:
            continue
        if choice == 0:
            return
        if 1 <= choice <= len(keys):
            loc_id = keys[choice - 1]
            fn = travel.get(loc_id)
            if fn:
                fn(state)
                return
            else:
                print_color("That location isn't reachable yet.", 150, 150, 150)
        elif choice == "Auxiliary":
            write_slow(
                "Yeah, hi, thanks. You've found an easter egg. Congrats! Uh... yeah. There wasn't any reason to do this, but thanks, man!",
                31,
                255,
                50,
                0,
            )
            press_any_key()
        else:
            show_map(state)
